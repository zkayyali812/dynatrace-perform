---
# =============================================================================
# Comment on Dynatrace Problem Playbook
# =============================================================================
# Adds a comment to a Dynatrace problem to document remediation actions.
# Dynatrace will automatically close the problem when it detects resolution.
# =============================================================================

- name: Comment on Dynatrace Problem
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    problem_id: "{{ problem_id | default('unknown') }}"
    comment: "{{ comment | default('Remediated by Ansible Automation Platform') }}"
    dynatrace_environment_url: "{{ lookup('env', 'DYNATRACE_URL') | default(dynatrace_environment_url, true) }}"
    dynatrace_api_token: "{{ lookup('env', 'DYNATRACE_API_TOKEN') | default(dynatrace_api_token, true) }}"

  tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - problem_id != 'unknown'
          - dynatrace_environment_url is defined
          - dynatrace_api_token is defined
        fail_msg: "Missing required variables for commenting on Dynatrace problem"
        success_msg: "All required variables present"

    - name: Get current problem status
      ansible.builtin.uri:
        url: "{{ dynatrace_environment_url }}/api/v2/problems/{{ problem_id }}"
        method: GET
        headers:
          Authorization: "Api-Token {{ dynatrace_api_token }}"
        status_code: [200]
        validate_certs: false
      register: problem_status
      ignore_errors: true

    - name: Display current problem status
      ansible.builtin.debug:
        msg: "Problem {{ problem_id }} status: {{ problem_status.json.status | default('unknown') }}"
      when: problem_status is succeeded

    - name: Add remediation comment to problem
      ansible.builtin.uri:
        url: "{{ dynatrace_environment_url }}/api/v2/problems/{{ problem_id }}/comments"
        method: POST
        headers:
          Authorization: "Api-Token {{ dynatrace_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          context: "Ansible Automation Platform - Remediation Complete"
          message: |
            {{ comment }}

            Remediation completed at: {{ ansible_date_time.iso8601 }}
            Executed by: Event-Driven Ansible
        status_code: [201, 200]
        validate_certs: false
      register: comment_result

    - name: Log comment status
      ansible.builtin.debug:
        msg: |
          ============================================
          DYNATRACE PROBLEM COMMENT ADDED
          ============================================
          Problem ID: {{ problem_id }}
          Comment Added: {{ 'Yes' if comment_result is succeeded else 'No' }}
          Timestamp: {{ ansible_date_time.iso8601 }}
          ============================================

          Note: Dynatrace will automatically close the problem
          when it detects the issue is resolved.
          ============================================

    - name: Set stats for workflow
      ansible.builtin.set_stats:
        data:
          problem_id: "{{ problem_id }}"
          comment_added: "{{ comment_result is succeeded }}"
          timestamp: "{{ ansible_date_time.iso8601 }}"
