---
# =============================================================================
# Reset Demo Environment
# =============================================================================
# Cleans up the demo environment so you can re-run demos:
# - Deletes stress test pods
# - Scales demo-app back to desired replicas
# - Clears any stuck pods
# - Ensures demo app is healthy
# =============================================================================
- name: Reset Demo Environment
  hosts: localhost
  gather_facts: false

  vars:
    target_namespace: "{{ target_namespace | default('demo-app') }}"
    demo_app_replicas: "{{ demo_app_replicas | default(2) }}"

  tasks:
    - name: "Reset: Delete stress test pods"
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: Pod
        name: "{{ item }}"
        namespace: "{{ target_namespace }}"
      loop:
        - stress-test
        - memory-stress
      ignore_errors: true

    - name: "Reset: Delete any completed/failed pods"
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: Pod
        namespace: "{{ target_namespace }}"
        label_selectors:
          - "app=demo-app"
        field_selectors:
          - "status.phase=Failed"
      ignore_errors: true

    - name: "Reset: Scale demo-app to desired replicas"
      kubernetes.core.k8s_scale:
        api_version: apps/v1
        kind: Deployment
        name: demo-app
        namespace: "{{ target_namespace }}"
        replicas: "{{ demo_app_replicas | int }}"
        wait: true
        wait_timeout: 120

    - name: "Reset: Wait for demo-app pods to be ready"
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: demo-app
        namespace: "{{ target_namespace }}"
      register: demo_deployment
      until:
        - demo_deployment.resources | length > 0
        - demo_deployment.resources[0].status.readyReplicas is defined
        - demo_deployment.resources[0].status.readyReplicas == (demo_app_replicas | int)
      retries: 12
      delay: 10

    - name: "Reset: Get current pod status"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ target_namespace }}"
        label_selectors:
          - "app=demo-app"
      register: demo_pods

    - name: "Reset: Environment ready"
      ansible.builtin.debug:
        msg:
          - "Demo environment has been reset!"
          - "Namespace: {{ target_namespace }}"
          - "Demo app replicas: {{ demo_app_replicas }}"
          - "Running pods: {{ demo_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}"
          - ""
          - "You can now trigger new problems for the demo."
