---
# =============================================================================
# Remediate Memory Exhaustion Playbook
# =============================================================================
# Triggered by EDA when Dynatrace detects memory issues
# Actions: Scale deployment, restart pods to release memory
# =============================================================================

- name: Remediate Memory Exhaustion on OpenShift/Kubernetes
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    _problem_id: "{{ problem_id | default('unknown') }}"
    _affected_entity: "{{ affected_entity | default('unknown') }}"
    _namespace: "{{ namespace | default('demo-app') }}"
    _scale_replicas: "{{ scale_replicas | default(3) }}"

  tasks:
    - name: Log remediation start
      ansible.builtin.debug:
        msg: |
          ============================================
          MEMORY REMEDIATION STARTED
          ============================================
          Problem ID: {{ _problem_id }}
          Problem Title: {{ problem_title | default('Memory Exhaustion') }}
          Affected Entity: {{ _affected_entity }}
          Namespace: {{ _namespace }}
          Target Replicas: {{ _scale_replicas }}
          ============================================

    - name: Extract deployment name from affected entity
      ansible.builtin.set_fact:
        deployment_name: "{{ _affected_entity | regex_replace('-[a-z0-9]{5,10}-[a-z0-9]{4,6}$', '') | default('demo-app', true) }}"
      when: _affected_entity != 'unknown'

    - name: Use default deployment name if entity unknown
      ansible.builtin.set_fact:
        deployment_name: "demo-app"
      when: _affected_entity == 'unknown' or deployment_name | default('') == ''

    - name: Get pods with high memory usage
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ _namespace }}"
        label_selectors:
          - "app={{ deployment_name }}"
      register: current_pods

    - name: Display current pod count
      ansible.builtin.debug:
        msg: "Current pod count: {{ current_pods.resources | length }}"

    - name: Scale deployment for memory distribution
      kubernetes.core.k8s_scale:
        api_version: apps/v1
        kind: Deployment
        name: "{{ deployment_name }}"
        namespace: "{{ _namespace }}"
        replicas: "{{ scale_replicas | int }}"
      register: scale_result

    - name: Delete pods to force memory release
      kubernetes.core.k8s:
        api_version: v1
        kind: Pod
        name: "{{ item.metadata.name }}"
        namespace: "{{ _namespace }}"
        state: absent
      loop: "{{ current_pods.resources[:2] }}"
      loop_control:
        label: "{{ item.metadata.name }}"
      when: current_pods.resources | length > 0

    - name: Wait for new pods to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: "{{ deployment_name }}"
        namespace: "{{ _namespace }}"
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 180

    - name: Log remediation complete
      ansible.builtin.debug:
        msg: |
          ============================================
          MEMORY REMEDIATION COMPLETED
          ============================================
          Problem ID: {{ _problem_id }}
          Deployment: {{ deployment_name }}
          New Replica Count: {{ _scale_replicas }}
          ============================================

    - name: Set stats for workflow
      ansible.builtin.set_stats:
        data:
          remediation_status: "success"
          problem_id: "{{ _problem_id }}"
          action_taken: "scale_and_restart"

    # -------------------------------------------------------------------------
    # Close Problem in Dynatrace (if close_problem is true)
    # -------------------------------------------------------------------------
    - name: Add remediation comment to Dynatrace problem
      ansible.builtin.uri:
        url: "{{ dynatrace_environment_url }}/api/v2/problems/{{ _problem_id }}/comments"
        method: POST
        headers:
          Authorization: "Api-Token {{ dynatrace_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          context: "Ansible Automation Platform"
          message: |
            Automated remediation completed successfully.

            Problem: {{ problem_title | default('Memory Exhaustion') }}
            Action: Scale and restart
            Deployment: {{ deployment_name }}
            New Replicas: {{ _scale_replicas }}
            Namespace: {{ _namespace }}
            Timestamp: {{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}
        status_code: [201, 200]
        validate_certs: false
      when:
        - close_problem | default(false) | bool
        - _problem_id != 'unknown'
        - dynatrace_environment_url is defined
        - dynatrace_api_token is defined
      ignore_errors: true

    - name: Log Dynatrace comment status
      ansible.builtin.debug:
        msg: "Added remediation comment to Dynatrace problem {{ _problem_id }}"
      when: close_problem | default(false) | bool
