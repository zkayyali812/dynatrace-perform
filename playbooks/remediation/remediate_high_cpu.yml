---
# =============================================================================
# Remediate High CPU Playbook
# =============================================================================
# Triggered by EDA when Dynatrace detects high CPU usage
# Actions: Identify high-CPU pods, restart or scale deployment
# =============================================================================

- name: Remediate High CPU on OpenShift/Kubernetes
  hosts: all
  gather_facts: false

  vars:
    _problem_id: "{{ problem_id | default('unknown') }}"
    _affected_entity: "{{ affected_entity | default('unknown') }}"
    _namespace: "{{ namespace | default('demo-app') }}"
    _action: "{{ action | default('restart') }}"
    _severity: "{{ severity | default('warning') }}"

  tasks:
    - name: Log remediation start
      ansible.builtin.debug:
        msg: |
          ============================================
          DYNATRACE PROBLEM REMEDIATION STARTED
          ============================================
          Problem ID: {{ _problem_id }}
          Problem Title: {{ problem_title | default('High CPU') }}
          Affected Entity: {{ _affected_entity }}
          Namespace: {{ _namespace }}
          Action: {{ _action }}
          Severity: {{ _severity }}
          ============================================

    - name: Extract deployment name from affected entity
      ansible.builtin.set_fact:
        # Strip pod hash suffixes (e.g., demo-app-7d9b8c6f45-x2k9m -> demo-app)
        # Pod names follow pattern: <deployment>-<replicaset-hash>-<pod-hash>
        deployment_name: "{{ _affected_entity | regex_replace('-[a-z0-9]{5,10}-[a-z0-9]{4,6}$', '') | default('demo-app', true) }}"
      when: _affected_entity != 'unknown'

    - name: Use default deployment name if entity unknown
      ansible.builtin.set_fact:
        deployment_name: "demo-app"
      when: _affected_entity == 'unknown' or deployment_name | default('') == ''

    - name: Get current deployment info
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: "{{ deployment_name }}"
        namespace: "{{ _namespace }}"
      register: deployment_info
      ignore_errors: true

    - name: Display current deployment status
      ansible.builtin.debug:
        msg: "Current replicas: {{ deployment_info.resources[0].spec.replicas | default('N/A') }}"
      when: deployment_info.resources | length > 0

    # -------------------------------------------------------------------------
    # Scale Action - Add more replicas to distribute load
    # -------------------------------------------------------------------------
    - name: Scale deployment to distribute CPU load
      kubernetes.core.k8s_scale:
        api_version: apps/v1
        kind: Deployment
        name: "{{ deployment_name }}"
        namespace: "{{ _namespace }}"
        replicas: "{{ (deployment_info.resources[0].spec.replicas | default(1) | int) + 2 }}"
      when:
        - _action in ['scale_only', 'restart_and_scale']
        - deployment_info.resources | length > 0
      register: scale_result

    - name: Wait for scaled pods to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: "{{ deployment_name }}"
        namespace: "{{ _namespace }}"
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 120
      when: scale_result is changed

    # -------------------------------------------------------------------------
    # Restart Action - Rolling restart of pods
    # -------------------------------------------------------------------------
    - name: Trigger rolling restart of deployment
      kubernetes.core.k8s:
        api_version: apps/v1
        kind: Deployment
        name: "{{ deployment_name }}"
        namespace: "{{ _namespace }}"
        definition:
          spec:
            template:
              metadata:
                annotations:
                  kubectl.kubernetes.io/restartedAt: "{{ ansible_date_time.iso8601 | default(lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ')) }}"
        merge_type: strategic-merge
      when: _action in ['restart', 'restart_and_scale']
      register: restart_result

    - name: Wait for rollout to complete
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: "{{ deployment_name }}"
        namespace: "{{ _namespace }}"
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 180
      when: restart_result is changed

    # -------------------------------------------------------------------------
    # Get final status
    # -------------------------------------------------------------------------
    - name: Get pods after remediation
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ _namespace }}"
        label_selectors:
          - "app={{ deployment_name }}"
      register: pods_after

    - name: Log remediation complete
      ansible.builtin.debug:
        msg: |
          ============================================
          REMEDIATION COMPLETED
          ============================================
          Problem ID: {{ _problem_id }}
          Deployment: {{ deployment_name }}
          Action Taken: {{ _action }}
          Pods Running: {{ pods_after.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}
          ============================================

    - name: Set stats for workflow
      ansible.builtin.set_stats:
        data:
          remediation_status: "success"
          problem_id: "{{ _problem_id }}"
          deployment_name: "{{ deployment_name }}"
          action_taken: "{{ _action }}"

    # -------------------------------------------------------------------------
    # Close Problem in Dynatrace (if close_problem is true)
    # -------------------------------------------------------------------------
    - name: Add remediation comment to Dynatrace problem
      ansible.builtin.uri:
        url: "{{ dynatrace_environment_url }}/api/v2/problems/{{ _problem_id }}/comments"
        method: POST
        headers:
          Authorization: "Api-Token {{ dynatrace_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          context: "Ansible Automation Platform"
          message: |
            Automated remediation completed successfully.

            Problem: {{ problem_title | default('High CPU') }}
            Action: {{ _action }}
            Deployment: {{ deployment_name }}
            Namespace: {{ _namespace }}
            Timestamp: {{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}
        status_code: [201, 200]
        validate_certs: false
      when:
        - close_problem | default(false) | bool
        - _problem_id != 'unknown'
        - dynatrace_environment_url is defined
        - dynatrace_api_token is defined
      ignore_errors: true

    - name: Log Dynatrace comment status
      ansible.builtin.debug:
        msg: "Added remediation comment to Dynatrace problem {{ _problem_id }}"
      when: close_problem | default(false) | bool
