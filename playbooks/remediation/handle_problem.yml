---
# =============================================================================
# Handle Dynatrace Problem Playbook
# =============================================================================
# Generic handler for Dynatrace problems - logs details and can acknowledge
# Used as default handler or first step in workflow
# =============================================================================

- name: Handle Dynatrace Problem
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    problem_id: "{{ problem_id | default('unknown') }}"
    problem_title: "{{ problem_title | default('Unknown Problem') }}"
    problem_details: "{{ problem_details | default({}) }}"
    dynatrace_environment_url: "{{ lookup('env', 'DYNATRACE_URL') | default(dynatrace_environment_url, true) }}"
    dynatrace_api_token: "{{ lookup('env', 'DYNATRACE_API_TOKEN') | default(dynatrace_api_token, true) }}"

  tasks:
    - name: Log problem received
      ansible.builtin.debug:
        msg: |
          ============================================
          DYNATRACE PROBLEM RECEIVED
          ============================================
          Timestamp: {{ ansible_date_time.iso8601 }}
          Problem ID: {{ problem_id }}
          Problem Title: {{ problem_title }}
          ============================================

    - name: Parse problem details
      ansible.builtin.debug:
        msg: |
          Problem Details:
          {{ problem_details | to_nice_yaml if problem_details else 'No additional details provided' }}
      when: problem_details | length > 0

    - name: Record problem in audit log
      ansible.builtin.lineinfile:
        path: /tmp/dynatrace_problems.log
        line: "{{ ansible_date_time.iso8601 }} | {{ problem_id }} | {{ problem_title }}"
        create: true
        mode: '0644'
      delegate_to: localhost

    - name: Add comment to Dynatrace problem
      ansible.builtin.uri:
        url: "{{ dynatrace_environment_url }}/api/v2/problems/{{ problem_id }}/comments"
        method: POST
        headers:
          Authorization: "Api-Token {{ dynatrace_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          context: "Ansible Automation Platform"
          message: "Problem received by Event-Driven Ansible. Automated remediation initiated."
        status_code: [201, 200]
        validate_certs: false
      when:
        - dynatrace_environment_url is defined
        - dynatrace_environment_url | length > 0
        - dynatrace_api_token is defined
        - dynatrace_api_token | length > 0
        - problem_id != 'unknown'
      ignore_errors: true
      register: comment_result

    - name: Log Dynatrace comment status
      ansible.builtin.debug:
        msg: "Comment added to Dynatrace problem: {{ 'Success' if comment_result is succeeded else 'Failed or skipped' }}"

    - name: Set problem info for downstream tasks
      ansible.builtin.set_stats:
        data:
          problem_id: "{{ problem_id }}"
          problem_title: "{{ problem_title }}"
          problem_received_at: "{{ ansible_date_time.iso8601 }}"
          handler_status: "acknowledged"
